{% load static %}
{%load crispy_forms_tags %}

{% load mathfilters %}
<!doctype html>

<html lang="en">
 
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rana Motors Limited - Invoice</title>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
    <link href="https://getbootstrap.com/docs/5.2/assets/css/docs.css" rel="stylesheet">
    <link rel="stylesheet" href="invoice.css">

    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />

</head>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tw-elements/dist/css/index.min.css" />
<script src="https://cdn.tailwindcss.com"></script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.bundle.min.js"
    integrity="sha384-A3rJD856KowSb7dwlZdYEkO39Gagi7vIsF0jrRAoQmDKKtQBHUuLZ9AsSv4jD4Xa"
    crossorigin="anonymous"></script>


    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<!-- Bootstrap CSS -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.4.1/dist/css/bootstrap.min.css"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">



    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    
    
    <!-- Add jQuery UI Autocomplete CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.0/themes/base/jquery-ui.css">
    
<style>
    * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
    }

    body {
        font-family: "Tahoma", sans-serif;
        font-size: 10px;
    }

    .container {
        font-family: "Tahoma", sans-serif;
        font-size: 12px;
        margin: auto;
        display: block;

    }

    h3 {
        font-size: 20px;
    }

    h5 {
        font-size: 17px;
    }

    h6 {
        font-size: 12px;
    }

    .my-0 {
        margin-left: -0.25rem;
    }


    .mt-n1 {
        margin-top: -.30rem !important;
    }


    .mt-n3 {
        margin-top: -1rem !important;
    }

    .mt-n2 {
        margin-right: -0.25rem !important;
    }
</style>
<title>cashmemeo</title>
</head>

<body>



    {% if messages %}
    <div class="messages">
        <ul>
        {% for message in messages %}
            <li class="{{ message.tags }}">
                <span class="message-content">{{ message }}</span>
                <button type="button" class="close-btn" aria-label="Close message">
                    <span aria-hidden="true">&times;</span>
                </button>
            </li>
        {% endfor %}
        </ul>
    </div>
{% endif %}

<script>
const closeButtons = document.querySelectorAll('.close-btn');

closeButtons.forEach(closeButton => {
  closeButton.addEventListener('click', function() {
    // Remove the message element associated with the clicked button
    this.parentElement.remove(); // Simplified using `remove()` for modern browsers
  });
});
</script>

<style>
.messages {
    /* Adjust styling as needed for spacing, borders, etc. */
    padding: 1rem;
    border: 1px solid #ddd;
    margin: 1rem 0;
    list-style: none; /* Remove default list styling */
}

.messages li {
    /* Adjust styling as needed for individual messages */
    padding: 0.5rem 1rem;
    display: flex; /* Allow for inline placement of message and close button */
    justify-content: space-between; /* Align items horizontally */
    align-items: center; /* Align items vertically */
    border-bottom: 1px solid #eee; /* Add subtle separation lines */
}

.message-content {
    /* Adjust styling as needed for message content */
    flex-grow: 1; /* Allow message content to expand to fill remaining space */
}

.close-btn {
    /* Adjust styling as needed for close button */
    background: none; /* Remove default button background */
    border: none; /* Remove default button border */
    padding: 0 5px; /* Add some padding for visual separation */
    cursor: pointer; /* Indicate clickable behavior */
    color: #888; /* Adjust color as needed */
    transition: color 0.2s ease-in-out; /* Add smooth color transition on hover */
}

.close-btn:hover {
    color: #333; /* Change color on hover */
}
</style>



    





 

        <nav class="flex items-center justify-between flex-wrap bg-stone-600 ">
            <div class="flex items-center flex-shrink-0 text-white mr-6">
              <img src="http://www.ranamotorsbd.com/images/Rana-Motors-Logo.png" class="top1 " alt="">
              <span class="font-semibold text-xl tracking-tight">RANA MOTORS</span>
            </div>
            <div class="block lg:hidden">
              <button class="flex items-center px-3 py-2 border rounded text-teal-200 border-teal-400 hover:text-white hover:border-white">
                <svg class="fill-current h-3 w-3" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>Menu</title><path d="M0 3h20v2H0V3zm0 6h20v2H0V9zm0 6h20v2H0v-2z"/></svg>
              </button>
            </div>
            <div class="w-full block flex-grow lg:flex lg:items-center lg:w-auto">
              <div class="text-sm lg:flex-grow">
                
        
              
                {% if user.is_authenticated %}
                    <a href="{% url 'logout' %}" class="block mt-4 lg:inline-block lg:mt-0 text-white hover:text-white mr-4">
                        Logout
                    </a>
        
                    <a href="{% url 'cart' %}" class="block mt-4 lg:inline-block lg:mt-0 text-white hover:text-white mr-4">
                      HOME
                  </a>

                  <a href="{% url 'soldlist' %}" class="block mt-4 lg:inline-block lg:mt-0 text-white hover:text-white mr-4">
                    invoice list
                </a>
                 
                   
                {% else %}
                    <a href="{% url 'login' %}" class="block mt-4 lg:inline-block lg:mt-0 text-orange-200 hover:text-white mr-4">
                        Login
                    </a>
                {% endif %}
              </div>
            </div>
          </nav>


          <div class="container">

        <div class="card card-one">

            

            <table class="table table-sm table-bordered border-dark mt-n1">
                <thead class="" style="background: rgba(77, 78, 83, 0.425);">
                    <tr>
                        <th class="text-center" scope="col">SL#</th>
                        <th class="text-center" scope="col">SPARE PRODUCT</th>
                        <th class="text-center" scope="col">MAIN GROUP</th>
                        <th class="text-center" scope="col">Group PRODUCT</th>
                        <th class="text-center" scope="col">SINGLE PRODUCT</th>
                        <th class="text-center" scope="col">Quantity</th>
                        <th class="text-center" scope="col">Unit Price</th>
                      
                        <th class="text-center" scope="col">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for rs in orders %}
                    <tr>
                        <td scope="row">{{ forloop.counter }}</td>
            
                        {% if rs.sparename %}
                            <td>{{ rs.sparename }} {{ rs.engine_no }}</td>
                            <td></td>
                            <td></td>
                            <td></td>

                        {% elif rs.product.mother == true %}
                            <td></td>
                            <td></td>
                            <td>{{ rs.product.name }} {{ rs.engine_no }}</td>
                            <td></td>
                        {% elif rs.product.groupname %}
                            <td></td>
                            <td>{{ rs.product.name }} {{ rs.engine_no }}</td>
                            <td></td>
                            <td></td>
                        {% elif rs.product.name %}
                            <td></td>
                            <td></td>
                            <td></td>
                            <td>{{ rs.product.name }} {{ rs.engine_no }}</td>
                        {% endif %}
            
                        <td class="text-right">{{ rs.quantity }}</td>
                        <td>{{ rs.price1 }}</td>
                        <td>
                            <button class="bg-blue-500 hover:bg-blue-700 text-blue-600 text-xs font-bold py-1 px-1 rounded w-40 mr-px"
                                onclick="window.location.href = '/{{ rs.id }}/fianaleditcashmemo'">
                                Edit
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            
            





            </div>


          




            
        </div>
    </div>
    <!-- code pro -->


   


              
                <div class="flex flex-col justify-between block  rounded-lg shadow-lg bg-white max-w-m p-3">
                    {% for product in user_products %}
                    <div class="flex justify-between my-1">
                        <p>
                            {{ product.quantity }} x {{ product.price1 }}<b> {{ product.product.name }}</b>
                        </p>
                        <p>
                            <span>${{ product.total_price }}</span>

                        </p>
                    </div>
                    {% endfor %}

                    {{ form.media }}
                    
                    

                   


                        <div id="product-container">
                            <!-- Products will be inserted here by JavaScript -->
                        </div>
    
                        {% load crispy_forms_tags %}
                    <form method="POST" class="post-form">
                        {% csrf_token %}
                        {{ form|crispy}}
                        <br>
                        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-blue-600 text-xs font-bold py-1 px-1 rounded w-40 mr-px">
                            <span class="glyphicon glyphicon-floppy-disk"></span> Save
                        </button>
                    </form>

                </div>
              
            </div>
        </div>
    </div>
    








    <div class="container">

        <div id="task-container">
            <div id="form-wrapper">
                
            </div>
    
            <div id="list-wrapper">
            
            </div>	
        </div>
    
    </div>


    <script type="text/javascript">
        /*
            KEY COMPONENTS:
            "activeItem" = null until an edit button is clicked. Will contain object of item we are editing
            "list_snapshot" = Will contain previous state of list. Used for removing extra rows on list update
            
            PROCESS:
            1 - Fetch Data and build rows "buildList()"
            2 - Create Item on form submit
            3 - Edit Item click - Prefill form and change submit URL
            4 - Delete Item - Send item id to delete URL
            5 - Cross out completed task - Event handle updated item
    
            NOTES:
            -- Add event handlers to "edit", "delete", "title"
            -- Render with strike through items completed
            -- Remove extra data on re-render
            -- CSRF Token
        */
    
    
    
        $(document).ready(function() {
            $("#country").autocomplete({
                source: "{% url 'autocomplete' %}",
                minLength: 2,
                select: function(event, ui) {
                    $("#country").val(ui.item.label);
                   
                    return false;
                }
            });
        });
    
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = cookies[i].trim();
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');
    
        var activeItem = null
        var list_snapshot = []
    
    
        loadProducts()
    
        function buildList(){
            var wrapper = document.getElementById('list-wrapper')
            //wrapper.innerHTML = ''
    
    
    
            var url = 'http://127.0.0.1:8000/api_productlist/'
    
            fetch(url)
            .then((resp) => resp.json())
            .then(function(data){
                console.log('Data:', data)
    
                var list = data
                for (var i in list){
    
    
                    try{
                        document.getElementById(`data-row-${i}`).remove()
                    }catch(err){
    
                    }
            
    
    
                    var title = `<span class="title">${list[i].productype}</span>`
                    
                  
                    
    
                    var item = `
                        <div id="data-row-${i}" class="task-wrapper flex-wrapper">
                            <div style="flex:7">
                                ${title}
                            </div>
                            <div style="flex:1">
                                <button class="btn btn-sm btn-outline-info edit">Edit </button>
                            </div>
                            <div style="flex:1">
                                <button class="btn btn-sm btn-outline-dark delete">-</button>
                            </div>
                        </div>
    
                    `
                    wrapper.innerHTML += item
    
                }
    
                if (list_snapshot.length > list.length){
                    for (var i = list.length; i < list_snapshot.length; i++){
                        document.getElementById(`data-row-${i}`).remove()
                    }
                }
    
                list_snapshot = list
    
    
                for (var i in list){
                    var editBtn = document.getElementsByClassName('edit')[i]
                    var deleteBtn = document.getElementsByClassName('delete')[i]
                    var title = document.getElementsByClassName('title')[i]
    
                    // editBtn.addEventListener('click', (function(item){
                    // 	return function(){
                    // 		editItem(item)
                    // 	}
                    // })(list[i]))
    
                    //Immediatly Invoked Function (IIF) + Closure for saving current loop item in memory
                    editBtn.addEventListener('click', (() => {
    
                        let item = list[i]
                        return () => {
                            editItem(item)
                        }
                    })())
    
    
                    deleteBtn.addEventListener('click', (function(item){
                        return function(){
                            deleteItem(item)
                        }
                    })(list[i]))
    
    
    
                    
                    title.addEventListener('click', (function(item){
                        return function(){
                            strikeUnstrike(item)
                        }
                    })(list[i]))
    
    
                }
    
    
            })
        }
    
    
        var form = document.getElementById('form-wrapper')
        form.addEventListener('submit', function(e){
            e.preventDefault()
            console.log('Form submitted')
            var url = 'http://127.0.0.1:8000/api/task-create/'
            if (activeItem != null){
                var url = `http://127.0.0.1:8000/api/task-update/${activeItem.id}/`
                activeItem = null
            }
    
    
    
            var title = document.getElementById('title').value
            fetch(url, {
                method:'POST',
                headers:{
                    'Content-type':'application/json',
                    'X-CSRFToken':csrftoken,
                },
                body:JSON.stringify({'title':title})
            }
            ).then(function(response){
                buildList()
                document.getElementById('form').reset()
            })
        })
    
    
    
    
        function editItem(item){
            console.log('Item clicked:', item)
            activeItem = item
            document.getElementById('title').value = activeItem.title
        }
    
    
        
    
    
        function loadProducts() {
        fetch('/api_productlist/')
            .then(response => response.json())
            .then(data => {
                let productContainer = document.getElementById('product-container');
                productContainer.innerHTML = ''; // Clear existing products
                console.log(data);
                const total = data.total_sum;
                document.getElementById('totalAmount').textContent = `$${total}`;
    
                // Loop through the tasks and create product elements
                for (let i = 0; i < data.tasks.length; i++) {
                    let item = data.tasks[i];
                    let productDiv = document.createElement('div');
                    productContainer.appendChild(productDiv);
                    productDiv.innerHTML = `
                    <div id="data-row-${i}" class="task-wrapper flex-wrapper">
                        ${item.quantity} x ${item.price1} <a href='${item.product.id}/update'> <b>${item.product.name}</b> </a>
                        <span>${item.quantity * item.price1} TK</span>
                        ${item.product.mother ? '<a href="' + item.product.id + '/group"><button class="bg-blue-500 hover:bg-blue-700 text-white text-xs font-bold py-1 px-1 rounded w-10 mr-px" onclick="groupProduct(' + item.product.id + ')">Group</button></a>' : ''}
    
                        <button class="ml-2 bg-red-500 hover:bg-red-700 text-white font-bold px-1 rounded delete" data-index="${i}">X</button>
                    </div>
                    `;
                }
    
                // Delete excess rows
                if (list_snapshot.length > data.tasks.length) {
                    for (let i = data.tasks.length; i < list_snapshot.length; i++) {
                        let rowToRemove = document.getElementById(`data-row-${i}`);
                        if (rowToRemove) {
                            rowToRemove.remove();
                        }
                    }
                }
    
                list_snapshot = data.tasks;
    
                // Attach event listeners to delete buttons
                let deleteButtons = document.getElementsByClassName('delete');
                for (let i = 0; i < deleteButtons.length; i++) {
                    deleteButtons[i].addEventListener('click', function () {
                        let index = this.getAttribute('data-index');
                        deleteItem(data.tasks[index]);
                    });
                }
            });
    }
    
    
    
    
    
    function deleteItem(item) {
            console.log('Delete clicked');
            console.log(item)
            fetch(`/api-delete/${item.id}`, {
                method: 'DELETE',
                headers: {
                    'Content-type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(data); // Log the response from the server
                loadProducts(); // Reload the products list after successful deletion
            })
            .catch(error => {
                console.error('Error:', error); // Log any errors that occurred
            });
        }
    
    
        function addItemcart(item) {
            console.log('Delete clicked');
            console.log(item)
            fetch(`/apiaddproduct/${item.id}`, {
                method: 'DELETE',
                headers: {
                    'Content-type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}',
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log(data); // Log the response from the server
                loadProducts(); // Reload the products list after successful deletion
            })
            .catch(error => {
                console.error('Error:', error); // Log any errors that occurred
            });
        }   
    
    
     
        function deleteproduct(id) {
        console.log('Delete clicked');
        console.log(id);
        fetch(`/api-delete/${id}`, {
            method: 'DELETE',
            headers: {
                'Content-type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}',
            }
        })
        .then(response => response.json())
        .then(data => {
            console.log(data); // Log the response from the server
            loadProducts(); // Reload the products list after successful deletion
        })
        .catch(error => {
            console.error('Error:', error); // Log any errors that occurred
        });
    }   
    
    
    
       
    
    
        const openModal = (productId, productName, price) => {
        const modal = document.getElementById("myModal");
        const modalTitle = modal.querySelector("#myModalLabel");
        const productIdField = modal.querySelector("#productId");
        const quantityField = modal.querySelector("#quantity");
        const priceField = modal.querySelector("#price");
    
        modalTitle.textContent = productName;
        productIdField.value = productId;
        quantityField.value = "";
        priceField.value = "";
    
        modal.classList.remove("hidden");
        document.body.classList.add("modal-open");
    };
    
    const closeModal = () => {
        const modal = document.getElementById("myModal");
        modal.classList.add("hidden");
        document.body.classList.remove("modal-open");
    };
    
    const addToCart = () => {
        const modal = document.getElementById("myModal");
        
    
        const productId = modal.querySelector("#productId").value;
        var product = document.getElementById("product").value;
        var quantity = document.getElementById("quantity").value;
        var price1 = document.getElementById("price").value;
        var price2 = document.getElementById("price2").value;
        var status = document.getElementById("status").value;
        var engine = document.getElementById("engine").value;
        var exchangeAmount = document.getElementById("exchangeAmount").value;
        var spareName = document.getElementById("spareName").value;
        var remarks = document.getElementById("remarks").value;
    
        console.log(productId)
    
    
        const formData = {
      productId: productId,
      product: product,
      quantity: quantity,
      price1: price1,
      price2: price2,
      status: status,
      engine: engine,
      exchangeAmount: exchangeAmount,
      spareName: spareName,
      remarks: remarks
    };
    
    // Make a POST request to the Django API endpoint
    fetch('/api_useritemstore/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(formData)
    })
      .then(response => response.json())
      .then(data => {
        console.log("API response:", data);
        loadProducts();
        // Handle the API response here
      })
      .catch(error => {
        console.error("Error:", error);
        // Handle the error here
      });
    
    
    
       
    
        closeModal();
        
    
        // Perform any additional validation or processing here
    
        // Submit the form or make an AJAX request to add the product to the cart
        //const form = modal.querySelector("#modalForm");
        //form.submit(); // Submit the form
        // Alternatively, make an AJAX request to add the product to the cart
    };  
    
    
    
    $(function() {
        $("#customer-autocomplete").autocomplete({
            source: "{% url 'customer-autocomplete' %}",
            minLength: 2,
        });
    });
    
    
    </script>
</body>

</html>